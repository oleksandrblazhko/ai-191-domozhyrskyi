# Тестування браузерного сховища

## Короткий опис

Браузери надають розробникам наступні механізми зберігання даних на стороні клієнта для зберігання та отримання даних:

Локальне сховище
Сховище сеансів
Індексована база даних
Web SQL (застарілий)
Файли cookie
Ці механізми зберігання можна переглядати і редагувати за допомогою інструментів розробника браузера, таких як Google Chrome DevTools або Інспектор сховища Firefox.

Примітка: Хоча кеш також є формою сховища, він розглядається в окремому розділі, що охоплює його особливості та проблеми.

## Цілі тестування

Визначити, чи зберігає веб-сайт конфіденційні дані у сховищі на стороні клієнта.
Код обробки об'єктів зберігання повинен бути перевірений на можливість ін'єкційних атак, таких як використання неперевіреного вводу або вразливих бібліотек.

## Як тестувати

### Локальне сховище
`window.localStorage` - це глобальний об'єкт, який реалізує інтерфейс Web Storage API та забезпечує постійне зберігання ключово-значеннєвих пар в браузері.

Як ключі, так і значення можуть бути лише рядками, тому будь-які значення, які не є рядками, повинні бути перетворені на рядки перед зберіганням, зазвичай це робиться за допомогою `JSON.stringify`.

Записи в `localStorage` залишаються, навіть коли вікно браузера закривається, за винятком вікон у режимі приватності / інкогніто.

Максимальна ємність сховища `localStorage` може відрізнятися в різних браузерах.

#### Список всіх ключово-значеннєвих записів
for (let i = 0; i < localStorage.length; i++) {
  const key = localStorage.key(i);
  const value = localStorage.getItem(key);
  console.log(`${key}: ${value}`);
}

### Сесійне сховище
window.sessionStorage - це глобальний об'єкт, який реалізує інтерфейс Web Storage API та забезпечує тимчасове зберігання ключово-значеннєвих пар в браузері.

Як ключі, так і значення можуть бути лише рядками, тому будь-які значення, які не є рядками, повинні бути перетворені на рядки перед зберіганням, зазвичай це робиться за допомогою JSON.stringify.

Записи в sessionStorage є тимчасовими, оскільки вони очищаються при закритті вкладки або вікна браузера.

Максимальна ємність сховища sessionStorage може відрізнятися в різних браузерах.

#### Список всіх ключово-значеннєвих записів

for (let i = 0; i < sessionStorage.length; i++) {
  const key = sessionStorage.key(i);
  const value = sessionStorage.getItem(key);
  console.log(`${key}: ${value}`);
}

### IndexedDB

IndexedDB - це транзакційна, об'єктно-орієнтована база даних, призначена для структурованих даних. База даних IndexedDB може містити кілька об'єктних сховищ, і кожне об'єктне сховище може містити кілька об'єктів.

На відміну від Локального та Сесійного сховищ, IndexedDB може зберігати більше, ніж лише рядки. В IndexedDB можна зберігати будь-які об'єкти, які підтримуються алгоритмом структурованого клонування.

Прикладом складного об'єкта JavaScript, який можна зберегти в IndexedDB, але не в Локальному або Сесійному сховищі, є CryptoKeys.

Рекомендація W3C щодо використання Web Crypto API рекомендує зберігати CryptoKeys, які потрібно зберігати в браузері, в IndexedDB. Під час тестування веб-сторінки шукайте будь-які CryptoKeys в IndexedDB і перевіряйте, чи вони встановлені як extractable: true, коли їх повинні були встановити як extractable: false (тобто забезпечуйте, щоб підлежний матеріал приватного ключа ніколи не викривався під час криптографічних операцій).

#### Виведення всіх вмісту IndexedDB

const dumpIndexedDB = dbName => {
  const DB_VERSION = 1;
  const req = indexedDB.open(dbName, DB_VERSION);
  req.onsuccess = function() {
    const db = req.result;
    const objectStoreNames = db.objectStoreNames || [];

    console.log(`[*] База даних: ${dbName}`);

    Array.from(objectStoreNames).forEach(storeName => {
      const txn = db.transaction(storeName, 'readonly');
      const objectStore = txn.objectStore(storeName);

      console.log(`\t[+] Об'єктне сховище: ${storeName}`);

      // Виведення всіх записів в об'єктному сховищі з назвою `storeName`
      objectStore.getAll().onsuccess = event => {
        const items = event.target.result || [];
        items.forEach(item => console.log(`\t\t[-] `, item));
      };
    });
  };
};

indexedDB.databases().then(dbs => dbs.forEach(db => dumpIndexedDB(db.name)));

### Web SQL

Web SQL був відзначений як застарілий з 18 листопада 2010 року і рекомендується веб-розробникам не використовувати його.

### Cookies

Cookies - це механізм зберігання ключово-значеннєвих пар, який використовується головним чином для управління сесіями, але веб-розробники все ще можуть використовувати їх для зберігання довільних рядкових даних.

Cookies розглядаються докладно в сценарії тестування атрибутів Cookies.

#### Список всіх Cookies

console.log(window.document.cookie);

### Глобальний об'єкт Window

Іноді веб-розробники ініціюють та зберігають глобальний стан, який доступний лише під час робочого життя сторінки, присвоюючи власні атрибути глобальному об'єкту Window. Наприклад:

window.MY_STATE = {
  counter: 0,
  flag: false,
};

Будь-які дані, приєднані до об'єкта Window, будуть втрачені при оновленні або закритті сторінки.

#### Список всіх записів в глобальному об'єкті Window

(() => {
  // створення iframe і додавання його до body для завантаження чистого глобального об'єкта Window
  const iframe = document.createElement('iframe');
  iframe.style.display = 'none';
  document.body.appendChild(iframe);

  // отримання поточного списку властивостей в глобальному об'єкті Window
  const currentWindow = Object.getOwnPropertyNames(window);

  // фільтрація списку відносно властивостей, які існують в чистому глобальному об'єкті
  const results = currentWindow.filter(
    prop => !iframe.contentWindow.hasOwnProperty(prop)
  );

  // видалення iframe
  document.body.removeChild(iframe);

  // виведення ключово-значеннєвих записів, які відрізняються
  results.forEach(key => console.log(`${key}: ${window[key]}`));
})();

### Ланцюг атак

Після ідентифікації будь-яких із зазначених вище векторів атак, може бути сформований ланцюжок атак з різними типами атак на стороні клієнта, такими як атаки на основі DOM XSS.

### Виправлення

Додатки повинні зберігати чутливі дані на серверному боці та забезпечувати їх безпеку відповідно до кращих практик.